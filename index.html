<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPS 彈跳運動教室 - 課程預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .gradient-text {
            background: linear-gradient(to right, #f97316, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-bar-bg {
            background-color: #e9ecef;
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .status-pending { background-color: #fef9c3; border-left: 5px solid #facc15; }
        .status-confirmed { background-color: #dcfce7; border-left: 5px solid #4ade80; }
        .status-full { background-color: #fee2e2; border-left: 5px solid #f87171; }
        .status-expired { background-color: #f3f4f6; border-left: 5px solid #9ca3af; color: #6b7280; }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0); } /* indigo-500 */
            50% { box-shadow: 0 0 20px 8px rgba(99, 102, 241, 0.4); }
        }
        .glow-animation {
            animation: glow 2s ease-in-out;
        }

        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake-animation {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="relative text-center mb-8">
            <div class="md:absolute md:top-1/2 md:left-0 md:-translate-y-1/2">
                <img src="https://scontent-tpe1-1.xx.fbcdn.net/v/t39.30808-6/445427957_122182603424031031_6822944940198727346_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=Fzi83KbtxCoQ7kNvwFO56qx&_nc_oc=AdlwG2oEyqXS_hGxr4z1HApKR3C8RIUX-OKWnxBJCh2l6nV3oiJhINBamr9vpWH2Gy3gIySFNDUBQhK-Jqyd7qpJ&_nc_zt=23&_nc_ht=scontent-tpe1-1.xx&_nc_gid=vvtEO2EDUYyGK2l8JKTX_w&oh=00_Afe1UK7EIhDUrufKx1j9rRWih-gCVFcSu4YWQVwDiGWxyg&oe=68EBCE75" alt="JPS 彈跳 LOGO" class="h-16 w-auto md:h-20 mx-auto mb-4 md:mx-0 md:mb-0">
            </div>
            <h1 id="main-title" class="text-4xl md:text-5xl font-black gradient-text">JPS 彈跳運動教室</h1>
            <p class="text-lg text-gray-600 mt-2">即時課程預約系統</p>
            <div id="adminLoginIconContainer" class="absolute top-0 right-0 p-2">
                <svg id="adminLoginIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 cursor-pointer hover:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" title="管理者登入">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
        </header>

        <div id="userInfoContainer" class="mb-6">
             <!-- User/Admin info will be injected here -->
        </div>

        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6 text-xs md:text-sm">
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-200 border border-yellow-400 mr-2"></span><span>招生中</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-200 border border-green-400 mr-2"></span><span>確定開課</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-200 border border-red-400 mr-2"></span><span>已額滿</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-200 border border-gray-400 mr-2"></span><span>已結束/公休</span></div>
        </div>
        
        <div id="schedule-wrapper" class="bg-white p-4 rounded-2xl shadow-lg overflow-x-auto">
            <div class="flex items-center justify-between mb-4 px-2">
                <button id="prevWeekBtn" title="前一週" class="p-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    <span class="hidden md:inline text-sm font-medium text-gray-700">前一週</span>
                </button>
                <div class="text-center">
                    <h3 id="weekRangeDisplay" class="text-lg font-bold text-gray-700"></h3>
                    <button id="todayBtn" class="text-xs px-2 py-1 mt-1 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors whitespace-nowrap">回到本週</button>
                </div>
                <button id="nextWeekBtn" title="後一週" class="p-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1">
                    <span class="hidden md:inline text-sm font-medium text-gray-700">下一週</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div id="scheduleContainer"></div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
        </footer>
    </div>

    <div id="adminPanel" class="hidden container mx-auto p-4 md:p-8 max-w-7xl mt-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800">管理者後台</h2>
                <button id="adminLogoutBtn" class="px-4 py-2 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">登出</button>
            </div>
            <div id="adminCourseList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="adminLoginModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>
    <div id="bookingModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none"></div>
    <div id="confirmModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>
    <div id="editDayModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, query, where, getDocs, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
			apiKey: "AIzaSyBIeXTW1yCsASMPY64HhdDoXYIygl08f34",
			authDomain: "jps-booking-system.firebaseapp.com",
			projectId: "jps-booking-system",
			storageBucket: "jps-booking-system.firebasestorage.app",
			messagingSenderId: "582146871191",
			appId: "1:582146871191:web:9b254fe25bba83fb133ed2"
		};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth;
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) { console.error("Firebase initialization failed:", e); }
        } else {
             document.body.innerHTML = "Firebase 設定無效或不存在。";
        }

        let currentUserId = null;
        let currentUserName = '';
        let currentDate = new Date();
        let isAdmin = false;
        let unsubscribeListeners = []; // Array to hold all active onSnapshot listeners

        const weekdays = ["週一", "週二", "週三", "週四", "週五", "週六"];
        const courseDetails = {
            "入門跳床": { type: "有氧", min: 3, max: 8 }, 
            "燃脂跳床": { type: "有氧", min: 3, max: 8 },
            "懸吊TRX": { type: "肌力", min: 1, max: 5 },
            "入門階梯": { type: "有氧", min: 3, max: 6 },
            "基礎肌力": { type: "肌力", min: 1, max: 6 }, 
            "壺鈴綜合訓練": { type: "肌力", min: 1, max: 6 },
        };
        
        const schedule = {
            "週一": { "18:15-19:00": "壺鈴綜合訓練", "19:15-20:00": "入門跳床", "20:15-21:15": "懸吊TRX" },
            "週二": { "10:00-10:45": "入門跳床", "14:00-14:45": "入門階梯", "19:15-20:00": "入門跳床", "20:15-21:00": "壺鈴綜合訓練" },
            "週三": { "10:00-10:45": "基礎肌力", "11:00-12:00": "懸吊TRX", "18:15-19:00": "基礎肌力", "19:15-20:00": "燃脂跳床" },
            "週四": { "10:00-10:45": "基礎肌力", "11:15-12:00": "入門階梯", "14:00-15:00": "懸吊TRX", "18:15-19:00": "入門跳床", "19:15-20:00": "基礎肌力", "20:15-21:15": "懸吊TRX" },
            "週五": { "10:00-10:45": "入門跳床", "11:15-12:00": "壺鈴綜合訓練", "14:00-14:45": "基礎肌力", "18:15-19:00": "入門階梯", "19:15-20:00": "燃脂跳床", "20:15-21:00": "基礎肌力"},
            "週六": { "10:00-10:45": "入門跳床", "11:15-12:00": "燃脂跳床" }
        };
        
        const userInfoContainer = document.getElementById('userInfoContainer');
        const adminLoginModalEl = document.getElementById('adminLoginModal');
        const bookingModalEl = document.getElementById('bookingModal');
        const confirmModalEl = document.getElementById('confirmModal');
        const editDayModalEl = document.getElementById('editDayModal');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayBtn = document.getElementById('todayBtn');

        function clearFirestoreListeners() {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        }
        
        function main() {
            if (!auth) {
                document.body.innerHTML = "Firebase authentication service is not available.";
                return;
            }
            onAuthStateChanged(auth, user => {
                if (user) handleUserSession(user);
                else signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed", err));
            });
        }
        main();

        function handleUserSession(user) {
            isAdmin = !user.isAnonymous;
            currentUserId = user.uid;
            currentUserName = isAdmin ? user.email : (localStorage.getItem('jpsUserName') || '');
            renderUserInfo();
            initializeSchedule();
            document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
            if (isAdmin) initializeAdminView();
        }

        function renderUserInfo() {
            const adminLoginIconContainer = document.getElementById('adminLoginIconContainer');
            if (isAdmin) {
                userInfoContainer.innerHTML = `<div class="p-3 bg-blue-100 border border-blue-200 rounded-lg text-center"><p class="text-sm text-blue-800">管理者模式：<strong>${currentUserName}</strong></p></div>`;
                adminLoginIconContainer.classList.add('hidden');
            } else {
                userInfoContainer.innerHTML = `
                    <div class="p-4 bg-orange-100 border border-orange-200 rounded-lg max-w-lg mx-auto w-full text-center">
                        <div class="flex items-center gap-2">
                            <label for="userNameInput" class="text-sm font-medium text-orange-800 whitespace-nowrap">您的姓名:</label>
                            <input type="text" id="userNameInput" class="w-full px-2 py-1 text-sm border-orange-300 rounded-md" placeholder="請輸入姓名以利報名">
                            <button id="saveNameBtn" class="px-4 py-1 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 relative overflow-hidden flex-shrink-0 w-20 h-8">
                                <span class="btn-text absolute inset-0 flex items-center justify-center transition-opacity duration-300">儲存</span>
                                <span class="save-feedback absolute inset-0 flex items-center justify-center bg-green-500 text-white rounded-md opacity-0 pointer-events-none transition-opacity duration-300">已儲存！</span>
                            </button>
                        </div>
                        <div id="user-guidance" class="text-sm text-gray-700 mt-3 h-5"></div>
                    </div>`;
                adminLoginIconContainer.classList.remove('hidden');
                document.getElementById('userNameInput').value = currentUserName;
                document.getElementById('saveNameBtn').addEventListener('click', saveUserName);
            }
        }

        function saveUserName() {
            const nameToSave = document.getElementById('userNameInput').value.trim();
            const guidanceEl = document.getElementById('user-guidance');
            const saveBtn = document.getElementById('saveNameBtn');
            const feedbackEl = saveBtn.querySelector('.save-feedback');
            const btnTextEl = saveBtn.querySelector('.btn-text');
            const scheduleWrapper = document.getElementById('schedule-wrapper');

            guidanceEl.innerHTML = '';

            if (nameToSave) {
                currentUserName = nameToSave;
                localStorage.setItem('jpsUserName', nameToSave);
                
                btnTextEl.classList.add('opacity-0');
                feedbackEl.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    btnTextEl.classList.remove('opacity-0');
                    feedbackEl.classList.add('opacity-0', 'pointer-events-none');
                }, 2000);

                guidanceEl.innerHTML = `<p class="text-indigo-700 font-semibold animate-pulse">您好，${currentUserName}！請點擊下方您想預約的課程。</p>`;
                scheduleWrapper.classList.add('glow-animation');
                scheduleWrapper.addEventListener('animationend', () => scheduleWrapper.classList.remove('glow-animation'), { once: true });
            } else {
                guidanceEl.innerHTML = `<p class="text-red-600 font-semibold">請輸入有效的姓名。</p>`;
                const userInput = document.getElementById('userNameInput');
                userInput.classList.add('shake-animation');
                userInput.addEventListener('animationend', () => userInput.classList.remove('shake-animation'), { once: true });
            }
        }
        
        document.getElementById('adminLoginIcon').addEventListener('click', () => {
            adminLoginModalEl.innerHTML = `...`; // Redacted for brevity
            openModal(adminLoginModalEl);
        });

        document.getElementById('adminLogoutBtn')?.addEventListener('click', () => {
            signOut(auth).then(() => window.location.reload()).catch(err => console.error("Sign out failed:", err));
        });

        function openModal(modal) {
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }
        function closeModal(modal) {
            modal.classList.add('opacity-0', 'pointer-events-none');
        }
        
        prevWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 7);
            initializeSchedule();
        });
        nextWeekBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 7);
            initializeSchedule();
        });
        todayBtn.addEventListener('click', () => {
            currentDate = new Date();
            initializeSchedule();
        });

        function getWeekInfo(refDate) {
            const today = new Date(refDate);
            today.setHours(0, 0, 0, 0); 
            const dayOfWeek = today.getDay(); 
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);
            const weekDates = Array.from({ length: 6 }, (_, i) => {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                return d;
            });
            const saturday = weekDates[5];
            const rangeStr = `${monday.getMonth() + 1}/${monday.getDate()} - ${saturday.getMonth() + 1}/${saturday.getDate()}`;
            return { weekDates, rangeStr };
        }

        function getClassDateTime(date, time) { 
            const [startTime] = time.split('-');
            const [hours, minutes] = startTime.split(':');
            const classDateTime = new Date(date);
            classDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return classDateTime;
        }

        function updateCardUI(courseId, courseData, classDateTime) {
            const cardElement = document.getElementById(courseId);
            if (!cardElement) return;

            const { attendees, courseName } = courseData;
            const details = courseDetails[courseName] || { min: 3, max: 8 };
            const currentCount = attendees?.length || 0;
            const isExpired = new Date() > classDateTime;

            cardElement.querySelector('.attendee-info').innerHTML = attendees && attendees.length > 0 ? attendees.map(p => `<div>${p.name}</div>`).join('') : '<div class="text-gray-400">尚無人報名</div>';
            cardElement.querySelector('.progress-bar').style.width = `${(currentCount / details.max) * 100}%`;
            cardElement.querySelector('.text-right').textContent = `${currentCount}/${details.max}`;

            cardElement.classList.remove('status-pending', 'status-confirmed', 'status-full', 'status-expired');
            if (isExpired) {
                cardElement.classList.add('status-expired');
                cardElement.querySelector('.progress-bar').classList.add('bg-gray-400');
            } else if (currentCount >= details.max) {
                cardElement.classList.add('status-full');
                cardElement.querySelector('.progress-bar').classList.add('bg-red-500');
            } else if (currentCount >= details.min) {
                cardElement.classList.add('status-confirmed');
                cardElement.querySelector('.progress-bar').classList.add('bg-green-500');
            } else {
                cardElement.classList.add('status-pending');
                cardElement.querySelector('.progress-bar').classList.add('bg-yellow-500');
            }
        }

        async function openBookingModal(courseId, classDateTime, courseName) {
            if (!currentUserName && !isAdmin) {
                alert("請先在上方輸入您的姓名並儲存，才能預約課程。");
                document.getElementById('userNameInput').focus();
                return;
            }
            const docRef = doc(db, `/artifacts/${appId}/public/data/courses`, courseId);
            const docSnap = await getDoc(docRef);
            const courseData = docSnap.exists() ? docSnap.data() : { attendees: [] };
            const bookingId = `${currentUserId}_${currentUserName}`;
            const isBooked = courseData.attendees?.some(p => p.id === bookingId);
            const now = new Date();
            const cancellationCutoffTime = new Date(classDateTime.getTime() - 60 * 60 * 1000);

            if (isBooked && now > cancellationCutoffTime) {
                alert("已超過可取消的時間（上課前一小時）。");
                return;
            }
            if (!isBooked && now > classDateTime) {
                alert("課程已經開始，無法預約。");
                return;
            }
            // ... (rest of modal generation is the same)
            bookingModalEl.innerHTML = `...`; // Redacted for brevity
            openModal(bookingModalEl);
        }

       async function handleBooking(courseId, isBooked, courseName, adminRemoveId = null) {
            const docRef = doc(db, `/artifacts/${appId}/public/data/courses`, courseId);
            try {
                const docSnap = await getDoc(docRef);
                const currentAttendees = docSnap.exists() ? docSnap.data().attendees || [] : [];
                let newAttendees;
                if (isBooked) {
                    const idToRemove = adminRemoveId || `${currentUserId}_${currentUserName}`;
                    newAttendees = currentAttendees.filter(p => p.id !== idToRemove);
                    await updateDoc(docRef, { attendees: newAttendees });
                } else {
                    if (!currentUserName) { alert("請輸入有效的姓名並儲存。"); return; }
                    const newUser = { id: `${currentUserId}_${currentUserName}`, name: currentUserName };
                    if (currentAttendees.some(p => p.id === newUser.id)) return;
                    newAttendees = [...currentAttendees, newUser];
                    if(docSnap.exists()) await updateDoc(docRef, { attendees: newAttendees });
                    else await setDoc(docRef, { courseName: courseName, attendees: newAttendees });
                }
            } catch (error) {
                console.error("Booking operation failed:", error);
                alert("操作失敗，請稍後再試。");
            } finally {
                closeModal(bookingModalEl);
            }
        }
        
        async function openEditDayModal(date, dayName, overrideData) {
            const daySchedule = schedule[dayName] || {};
            let classEditHtml = Object.keys(daySchedule).map(originalTime => {
                const courseName = schedule[dayName][originalTime];
                const overrideClass = overrideData?.classChanges?.[originalTime] || courseName;
                const overrideTime = overrideData?.timeChanges?.[originalTime] || originalTime;
                const isCancelled = overrideData?.cancelledClasses?.includes(originalTime);
                const courseOptions = Object.keys(courseDetails).map(cName => `<option value="${cName}" ${cName === overrideClass ? 'selected' : ''}>${cName}</option>`).join('');
                return `
                    <div class="class-edit-item grid grid-cols-[auto,1fr,1fr] md:grid-cols-[20px,1fr,1fr,1fr] gap-3 items-center p-3 bg-gray-50 rounded-lg" data-original-time="${originalTime}">
                        <input type="checkbox" class="cancel-checkbox h-5 w-5" ${isCancelled ? 'checked' : ''}>
                        <div class="text-sm">
                            <p class="font-semibold ${isCancelled ? 'line-through' : ''}">${courseName}</p>
                            <p class="text-xs text-gray-500">${originalTime}</p>
                        </div>
                        <div class="md:col-span-1"><label class="block text-xs text-gray-600 mb-1">更換課程</label><select class="course-select w-full text-sm p-1 border rounded-md" ${isCancelled ? 'disabled' : ''}>${courseOptions}</select></div>
                        <div class="md:col-span-1"><label class="block text-xs text-gray-600 mb-1">修改時間</label><input type="text" class="time-input w-full text-sm p-1 border rounded-md" value="${overrideTime}" ${isCancelled ? 'disabled' : ''}></div>
                    </div>`;
            }).join('');
            if (!classEditHtml) classEditHtml = '<p class="text-center text-gray-500 py-4">本日無預設課程。</p>';

            editDayModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-2xl m-4 flex flex-col max-h-[85vh]">
                    <div class="p-6 pb-4 flex-shrink-0 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-center mb-1">編輯 ${date} (${dayName})</h3>
                        <div class="text-center text-gray-500 mt-2">
                            <label class="flex items-center justify-center gap-2 cursor-pointer">
                                <input type="checkbox" id="restDayCheckbox" class="h-5 w-5" ${overrideData?.status === 'rest_day' ? 'checked' : ''}>
                                設定為公休日
                            </label>
                        </div>
                    </div>
                    <div id="class-edit-container" class="flex-grow overflow-y-auto p-6 space-y-3 ${overrideData?.status === 'rest_day' ? 'opacity-40 pointer-events-none' : ''}">
                        ${classEditHtml}
                    </div>
                    <div class="p-4 flex-shrink-0 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                        <div class="flex flex-wrap justify-end gap-3">
                            ${overrideData ? '<button id="deleteOverridesBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">移除本日設定</button>' : ''}
                            <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                            <button id="saveOverridesBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
                        </div>
                    </div>
                </div>`;

            const restDayCheckbox = editDayModalEl.querySelector('#restDayCheckbox');
            const classEditContainer = editDayModalEl.querySelector('#class-edit-container');
            restDayCheckbox.addEventListener('change', (e) => {
               classEditContainer.classList.toggle('opacity-40', e.target.checked);
               classEditContainer.classList.toggle('pointer-events-none', e.target.checked);
            });
            editDayModalEl.querySelectorAll('.cancel-checkbox').forEach(box => {
                box.addEventListener('change', (e) => {
                    const item = e.target.closest('.class-edit-item');
                    item.querySelector('.font-semibold').classList.toggle('line-through', e.target.checked);
                    item.querySelector('.course-select').disabled = e.target.checked;
                    item.querySelector('.time-input').disabled = e.target.checked;
                });
            });
            editDayModalEl.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(editDayModalEl));
            editDayModalEl.querySelector('#saveOverridesBtn').addEventListener('click', () => handleSaveOverrides(date, dayName));
            const deleteBtn = editDayModalEl.querySelector('#deleteOverridesBtn');
            if(deleteBtn) deleteBtn.addEventListener('click', () => handleDeleteOverrides(date));
            openModal(editDayModalEl);
        }

        async function handleSaveOverrides(date, dayName) {
            const isRestDay = document.getElementById('restDayCheckbox').checked;
            const newOverrideData = { date };
            if (isRestDay) {
                newOverrideData.status = 'rest_day';
            } else {
                newOverrideData.cancelledClasses = [];
                newOverrideData.classChanges = {};
                newOverrideData.timeChanges = {};
                document.querySelectorAll('.class-edit-item').forEach(item => {
                    const originalTime = item.dataset.originalTime;
                    if (item.querySelector('.cancel-checkbox').checked) {
                        newOverrideData.cancelledClasses.push(originalTime);
                        return;
                    }
                    const newCourse = item.querySelector('.course-select').value;
                    if (newCourse !== schedule[dayName][originalTime]) newOverrideData.classChanges[originalTime] = newCourse;
                    const newTime = item.querySelector('.time-input').value;
                    if (newTime !== originalTime) newOverrideData.timeChanges[originalTime] = newTime;
                });
                if (Object.keys(newOverrideData.classChanges).length === 0) delete newOverrideData.classChanges;
                if (Object.keys(newOverrideData.timeChanges).length === 0) delete newOverrideData.timeChanges;
                if (newOverrideData.cancelledClasses.length === 0) delete newOverrideData.cancelledClasses;
            }
            if (Object.keys(newOverrideData).length <= 1) {
                await handleDeleteOverrides(date); 
                return;
            }
            const docRef = doc(db, `/artifacts/${appId}/public/data/schedule_overrides`, date);
            try {
                await setDoc(docRef, newOverrideData);
            } catch (error) {
                console.error("Failed to save overrides:", error);
                alert("儲存設定失敗！");
            } finally {
                closeModal(editDayModalEl);
                initializeSchedule();
            }
        }
        
        async function handleDeleteOverrides(date) {
            const docRef = doc(db, `/artifacts/${appId}/public/data/schedule_overrides`, date);
            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Failed to delete overrides:", error);
                alert("移除設定失敗！");
            } finally {
                closeModal(editDayModalEl);
                initializeSchedule();
            }
        }

        function initializeAdminView() {
            document.getElementById('adminCourseList').innerHTML = '<p>管理員後台功能正在開發中...</p>';
        }

        async function initializeSchedule() {
            clearFirestoreListeners(); 
            if (!currentUserId) return;
            const { weekDates, rangeStr } = getWeekInfo(currentDate);
            document.getElementById('weekRangeDisplay').textContent = rangeStr;

            const startDate = weekDates[0].toISOString().slice(0, 10);
            const endDate = weekDates[5].toISOString().slice(0, 10);
            const overrides = {};
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/schedule_overrides`), where('date', '>=', startDate), where('date', '<=', endDate));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => { overrides[doc.data().date] = doc.data(); });
            } catch (error) {
                console.error("Could not fetch schedule overrides.", error);
                if (error.code === 'permission-denied') {
                    document.getElementById('app').innerHTML = `<div class="..."><p>無法載入課表...</p></div>`;
                    return; 
                }
            }
            
            scheduleContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = "w-full min-w-[900px] border-collapse text-center";
            const thead = document.createElement('thead');
            // ... table head generation ...
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            // ... table body generation ...
            table.appendChild(tbody);
            scheduleContainer.appendChild(table);
            
            scheduleContainer.querySelectorAll('.edit-day-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.target.closest('.edit-day-btn');
                    openEditDayModal(button.dataset.date, button.dataset.dayName, overrides[button.dataset.date]);
                });
            });
        }
    </script>
</body>
</html>

