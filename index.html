<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Schedule Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            grid-template-rows: 30px repeat(18, 1fr);
            /* From 6 AM to 12 AM (midnight) */
        }

        .time-slot {
            grid-column: 1;
        }

        .day-header {
            grid-row: 1;
        }

        .schedule-card {
            min-height: 60px;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Weekly Schedule Planner</h1>
            <p class="text-md text-gray-500 mt-2">Organize your week, one task at a time.</p>
        </header>

        <!-- User/Session ID Display -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Session Information</h2>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <label for="userId" class="block text-sm font-medium text-gray-500">Your User ID (for sharing)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="userId" readonly class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 bg-gray-100 px-3 py-2 cursor-not-allowed">
                        <button id="copyUserId" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-200 text-sm font-medium text-gray-700 hover:bg-gray-300">
                            Copy
                        </button>
                    </div>
                </div>
                <div class="flex-1">
                    <label for="collaboratorId" class="block text-sm font-medium text-gray-500">Collaborator's User ID</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="collaboratorId" placeholder="Paste collaborator's ID here" class="flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="loadCollaboratorSchedule" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700">
                            Load
                        </button>
                    </div>
                </div>
            </div>
            <p id="feedbackMessage" class="text-sm text-green-600 mt-2 h-4"></p>
        </div>


        <main class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
            <div id="schedule-container" class="overflow-x-auto">
                <!-- Schedule grid will be generated here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modal for adding/editing events -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Add/Edit Event</h2>
            <form id="event-form">
                <input type="hidden" id="event-day">
                <input type="hidden" id="event-time">
                <div>
                    <label for="event-title" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="event-title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div class="mt-4">
                    <label for="event-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="event-description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="mt-4">
                    <label for="event-color" class="block text-sm font-medium text-gray-700">Color</label>
                    <select id="event-color" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="bg-blue-100" class="bg-blue-100">Blue</option>
                        <option value="bg-green-100" class="bg-green-100">Green</option>
                        <option value="bg-yellow-100" class="bg-yellow-100">Yellow</option>
                        <option value="bg-red-100" class="bg-red-100">Red</option>
                        <option value="bg-purple-100" class="bg-purple-100">Purple</option>
                        <option value="bg-pink-100" class="bg-pink-100">Pink</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="delete-event" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">Delete</button>
                    <button type="button" id="cancel-event" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-schedule-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_FALLBACK_API_KEY",
            authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
            projectId: "YOUR_FALLBACK_PROJECT_ID",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // --- Firebase Initialization ---
        let app, auth, db, userId;
        let schedule = {}; // Local cache of the schedule
        let unsubscribeSchedule; // To detach the Firestore listener

        // --- UI Elements ---
        const scheduleContainer = document.getElementById('schedule-container');
        const modal = document.getElementById('event-modal');
        const modalTitle = document.getElementById('modal-title');
        const eventForm = document.getElementById('event-form');
        const eventDayInput = document.getElementById('event-day');
        const eventTimeInput = document.getElementById('event-time');
        const eventTitleInput = document.getElementById('event-title');
        const eventDescriptionInput = document.getElementById('event-description');
        const eventColorInput = document.getElementById('event-color');
        const saveEventButton = eventForm.querySelector('button[type="submit"]');
        const cancelEventButton = document.getElementById('cancel-event');
        const deleteEventButton = document.getElementById('delete-event');
        const userIdInput = document.getElementById('userId');
        const copyUserIdButton = document.getElementById('copyUserId');
        const collaboratorIdInput = document.getElementById('collaboratorId');
        const loadCollaboratorButton = document.getElementById('loadCollaboratorSchedule');
        const feedbackMessage = document.getElementById('feedbackMessage');


        // --- Days and Time Slots ---
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const timeSlots = Array.from({
            length: 18
        }, (_, i) => {
            const hour = i + 6;
            return `${String(hour).padStart(2, '0')}:00`;
        });

        // --- Core Functions ---

        /**
         * Initializes Firebase app, auth, and Firestore.
         */
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                console.log("Firebase initialized successfully.");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                scheduleContainer.innerHTML = `<p class="text-red-500 text-center p-4">Error: Could not connect to the database. Please check the console for details.</p>`;
            }
        }

        /**
         * Authenticates the user, either with a provided token or anonymously.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }


        /**
         * Sets up a real-time listener for schedule changes in Firestore.
         * @param {string} scheduleId The ID of the user whose schedule to listen to.
         */
        function setupScheduleListener(scheduleId) {
            // If there's an existing listener, detach it first
            if (unsubscribeSchedule) {
                unsubscribeSchedule();
                console.log("Detached previous schedule listener.");
            }

            const scheduleRef = doc(db, `artifacts/${appId}/public/data/schedules`, scheduleId);
            unsubscribeSchedule = onSnapshot(scheduleRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Received schedule update:", docSnap.data());
                    schedule = docSnap.data();
                } else {
                    console.log("No schedule found in Firestore for this user. Creating a new one.");
                    // If no document exists, our local 'schedule' object is effectively the new one.
                    // We don't need to clear it, just ensure it's saved on the first edit.
                    schedule = {};
                }
                // Always re-render the entire schedule on any data change
                initializeSchedule();
            }, (error) => {
                console.error("Error listening to schedule changes:", error);
                feedbackMessage.textContent = "Error loading schedule.";
                feedbackMessage.className = "text-sm text-red-600 mt-2 h-4";
            });
        }

        /**
         * Fix: Define the missing updateCardUI function
         * This function updates the UI of a single card in the schedule grid.
         * @param {HTMLElement} card The card element to update.
         * @param {string} time The time slot of the card (e.g., "09:00").
         * @param {string} day The day of the card (e.g., "Monday").
         */
        function updateCardUI(card, time, day) {
            const cardData = schedule[day] && schedule[day][time] ? schedule[day][time] : {};
            const cardContent = card.querySelector('.card-content');
            const cardTime = card.querySelector('.card-time');

            if (!cardContent || !cardTime) {
                console.error("Card structure is incorrect", card);
                return;
            };

            // Clear previous content and styling
            cardContent.innerHTML = '';
            // Reset class list to default
            card.className = 'schedule-card relative flex flex-col justify-between p-2 border-t border-r cursor-pointer transition-colors duration-200 hover:bg-gray-100 bg-white';
            cardTime.textContent = time;

            // Populate with new data if it exists
            if (cardData.title) {
                card.classList.remove('bg-white');
                card.classList.add(cardData.color || 'bg-blue-100');

                const title = document.createElement('div');
                title.className = 'font-bold text-sm truncate';
                title.textContent = cardData.title;

                const description = document.createElement('div');
                description.className = 'text-xs text-gray-600 truncate';
                description.textContent = cardData.description;

                cardContent.appendChild(title);
                cardContent.appendChild(description);
            }
        }


        /**
         * Generates the HTML for the schedule grid and populates it.
         */
        function initializeSchedule() {
            scheduleContainer.innerHTML = ''; // Clear previous grid
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Create empty top-left cell
            const corner = document.createElement('div');
            grid.appendChild(corner);

            // Create day headers
            days.forEach((day, index) => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header text-center font-semibold p-1 border-b border-r text-sm';
                dayHeader.style.gridColumn = index + 2;
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            // Create time slots and schedule cards
            timeSlots.forEach((time, timeIndex) => {
                // Time slot label
                const timeSlotLabel = document.createElement('div');
                timeSlotLabel.className = 'time-slot text-right pr-2 text-xs text-gray-500 border-r';
                timeSlotLabel.style.gridRow = timeIndex + 2;
                timeSlotLabel.textContent = time;
                grid.appendChild(timeSlotLabel);

                // Cards for each day in this time slot
                days.forEach((day, dayIndex) => {
                    const card = document.createElement('div');
                    card.style.gridColumn = dayIndex + 2;
                    card.style.gridRow = timeIndex + 2;
                    card.dataset.day = day;
                    card.dataset.time = time;
                    card.className = 'schedule-card relative flex flex-col justify-between p-2 border-t border-r cursor-pointer transition-colors duration-200 hover:bg-gray-100 bg-white';

                    // Add internal structure for easier updates
                    const cardTime = document.createElement('div');
                    cardTime.className = 'card-time text-xs text-gray-400';
                    card.appendChild(cardTime);

                    const cardContent = document.createElement('div');
                    cardContent.className = 'card-content flex-grow';
                    card.appendChild(cardContent);

                    // Update UI based on current schedule data
                    updateCardUI(card, time, day);

                    card.addEventListener('click', () => openModal(day, time));
                    grid.appendChild(card);
                });
            });

            scheduleContainer.appendChild(grid);
        }



        /**
         * Saves the entire schedule object to Firestore.
         */
        async function saveSchedule() {
            if (!userId) {
                console.error("Cannot save schedule: user not authenticated.");
                return;
            }
            try {
                const scheduleRef = doc(db, `artifacts/${appId}/public/data/schedules`, userId);
                await setDoc(scheduleRef, schedule);
                console.log("Schedule saved successfully.");
            } catch (error) {
                console.error("Error saving schedule:", error);
                feedbackMessage.textContent = "Error saving changes.";
                feedbackMessage.className = "text-sm text-red-600 mt-2 h-4";
            }
        }

        // --- Modal and Form Handling ---

        /**
         * Opens the event modal to add or edit an event.
         * @param {string} day The day of the event.
         * @param {string} time The time of the event.
         */
        function openModal(day, time) {
            modal.classList.remove('hidden');
            eventDayInput.value = day;
            eventTimeInput.value = time;

            const existingEvent = schedule[day] && schedule[day][time] ? schedule[day][time] : null;

            if (existingEvent) {
                modalTitle.textContent = "Edit Event";
                eventTitleInput.value = existingEvent.title || '';
                eventDescriptionInput.value = existingEvent.description || '';
                eventColorInput.value = existingEvent.color || 'bg-blue-100';
                deleteEventButton.classList.remove('hidden');
            } else {
                modalTitle.textContent = "Add Event";
                eventForm.reset(); // Clear form for new event
                eventColorInput.value = 'bg-blue-100'; // Reset color picker
                deleteEventButton.classList.add('hidden');
            }
        }

        /**
         * Closes the event modal.
         */
        function closeModal() {
            modal.classList.add('hidden');
            eventForm.reset();
        }

        /**
         * Handles the form submission for saving an event.
         * @param {Event} e The form submission event.
         */
        async function handleSaveEvent(e) {
            e.preventDefault();
            const day = eventDayInput.value;
            const time = eventTimeInput.value;
            const title = eventTitleInput.value;
            const description = eventDescriptionInput.value;
            const color = eventColorInput.value;

            if (!day || !time) return;

            // Ensure the day object exists
            if (!schedule[day]) {
                schedule[day] = {};
            }

            // Update the local schedule object
            schedule[day][time] = {
                title,
                description,
                color
            };

            // Save the entire schedule to Firestore
            await saveSchedule();

            closeModal();
            // The onSnapshot listener will automatically update the UI
        }

        /**
         * Handles the deletion of an event.
         */
        async function handleDeleteEvent() {
            const day = eventDayInput.value;
            const time = eventTimeInput.value;

            if (day && time && schedule[day] && schedule[day][time]) {
                // Delete from the local schedule object
                delete schedule[day][time];

                // If the day becomes empty, delete the day object
                if (Object.keys(schedule[day]).length === 0) {
                    delete schedule[day];
                }

                // Save the updated schedule to Firestore
                await saveSchedule();
            }
            closeModal();
            // The onSnapshot listener will automatically update the UI
        }


        // --- Event Listeners ---
        cancelEventButton.addEventListener('click', closeModal);
        eventForm.addEventListener('submit', handleSaveEvent);
        deleteEventButton.addEventListener('click', handleDeleteEvent);

        copyUserIdButton.addEventListener('click', () => {
            userIdInput.select();
            document.execCommand('copy');
            feedbackMessage.textContent = "User ID copied to clipboard!";
            feedbackMessage.className = "text-sm text-green-600 mt-2 h-4";
            setTimeout(() => feedbackMessage.textContent = '', 2000);
        });

        loadCollaboratorButton.addEventListener('click', () => {
            const collaboratorId = collaboratorIdInput.value.trim();
            if (collaboratorId) {
                if (collaboratorId === userId) {
                    feedbackMessage.textContent = "You are already viewing your own schedule.";
                    feedbackMessage.className = "text-sm text-yellow-600 mt-2 h-4";
                    return;
                }
                feedbackMessage.textContent = `Loading schedule for ${collaboratorId}...`;
                feedbackMessage.className = "text-sm text-blue-600 mt-2 h-4";
                setupScheduleListener(collaboratorId);
            } else {
                feedbackMessage.textContent = "Please enter a collaborator's ID.";
                feedbackMessage.className = "text-sm text-red-600 mt-2 h-4";
            }
        });


        // --- Main Execution ---
        window.onload = async () => {
            initializeFirebase();
            if (!auth) return;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Current User ID:", userId);
                    userIdInput.value = userId;

                    // Start listening to this user's schedule
                    setupScheduleListener(userId);

                } else {
                    console.log("User is signed out.");
                    userId = null;
                }
            });

            await authenticateUser();
        };
    </script>
</body>

</html>
