<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPS 彈跳運動教室 - 課程預約系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .gradient-text {
            background: linear-gradient(to right, #f97316, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-bar-bg {
            background-color: #e9ecef;
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .status-pending { background-color: #fef9c3; border-left: 5px solid #facc15; }
        .status-confirmed { background-color: #dcfce7; border-left: 5px solid #4ade80; }
        .status-full { background-color: #fee2e2; border-left: 5px solid #f87171; }
        .status-expired { background-color: #f3f4f6; border-left: 5px solid #9ca3af; color: #6b7280; }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0); } /* indigo-500 */
            50% { box-shadow: 0 0 20px 8px rgba(99, 102, 241, 0.4); }
        }
        .glow-animation {
            animation: glow 2s ease-in-out;
        }

        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake-animation {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="relative text-center mb-8">
            <div class="md:absolute md:top-1/2 md:left-0 md:-translate-y-1/2">
                <img src="彈跳LOGO.jpg" alt="JPS 彈跳 LOGO" class="h-16 w-auto md:h-20 mx-auto mb-4 md:mx-0 md:mb-0" onerror="this.style.display='none'; this.onerror=null;">
            </div>
            <h1 id="main-title" class="text-4xl md:text-5xl font-black gradient-text">JPS 彈跳運動教室</h1>
            <p class="text-lg text-gray-600 mt-2">即時課程預約系統</p>
            <div id="adminLoginIconContainer" class="absolute top-0 right-0 p-2">
                <svg id="adminLoginIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 cursor-pointer hover:text-blue-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" title="管理者登入">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>
        </header>

        <div id="userInfoContainer" class="mb-6">
            <!-- User/Admin info will be injected here -->
        </div>

        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6 text-xs md:text-sm">
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-200 border border-yellow-400 mr-2"></span><span>招生中</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-200 border border-green-400 mr-2"></span><span>確定開課</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-200 border border-red-400 mr-2"></span><span>已額滿</span></div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-200 border border-gray-400 mr-2"></span><span>已結束/公休</span></div>
        </div>
        
        <div id="schedule-wrapper" class="bg-white p-4 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-4 px-2">
                <button id="prevWeekBtn" title="前一週" class="p-2 rounded-full bg-gray-100 border border-gray-200 shadow-sm hover:bg-gray-200 transition-colors flex items-center gap-1 md:rounded-lg md:px-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    <span class="hidden md:inline text-sm font-medium text-gray-700">前一週</span>
                </button>
                <div class="text-center">
                    <h3 id="weekRangeDisplay" class="text-lg font-bold text-gray-700"></h3>
                    <button id="todayBtn" class="text-xs px-2 py-1 mt-1 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors whitespace-nowrap">回到本週</button>
                </div>
                <button id="nextWeekBtn" title="後一週" class="p-2 rounded-full bg-gray-100 border border-gray-200 shadow-sm hover:bg-gray-200 transition-colors flex items-center gap-1 md:rounded-lg md:px-3">
                    <span class="hidden md:inline text-sm font-medium text-gray-700">下一週</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="overflow-x-auto">
                 <div id="scheduleContainer"></div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
        </footer>
    </div>

    <div id="adminPanel" class="hidden container mx-auto p-4 md:p-8 max-w-7xl mt-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800">管理者後台</h2>
                <div class="flex gap-4">
                     <button id="editScheduleTemplateBtn" class="px-4 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700 transition-colors">
                        編輯預設週課表
                    </button>
                    <button id="adminLogoutBtn" class="px-4 py-2 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">
                        登出
                    </button>
                </div>
            </div>
            <div id="adminCourseList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Admin content will be loaded here, possibly for specific course management -->
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="adminLoginModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>
    <div id="bookingModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none"></div>
    <div id="confirmModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>
    <div id="editDayModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>
    <!-- New Modal for editing schedule template -->
    <div id="editScheduleTemplateModal" class="modal fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60 opacity-0 pointer-events-none"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection, query, where, getDocs, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Config ---
        // 您的 Firebase 設定
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey":"AIzaSyBIeXTW1yCsASMPY64HhdDoXYIygl08f34","authDomain":"jps-booking-system.firebaseapp.com","projectId":"jps-booking-system","storageBucket":"jps-booking-system.firebasestorage.app","messagingSenderId":"582146871191","appId":"1:582146871191:web:9b254fe25bba83fb133ed2"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Global Variables ---
        let db, auth;
        let currentUserId = null;
        let currentUserName = '';
        let currentDate = new Date();
        let isAdmin = false;
        let unsubscribeListeners = [];

        // --- Course & Schedule Definitions ---
        const weekdays = ["週一", "週二", "週三", "週四", "週五", "週六"];
        const courseDetails = {
            "入門跳床": { type: "有氧", min: 3, max: 8 }, 
            "燃脂跳床": { type: "有氧", min: 3, max: 8 },
            "懸吊TRX": { type: "肌力", min: 1, max: 5 },
            "入門階梯": { type: "有氧", min: 3, max: 6 },
            "基礎肌力": { type: "肌力", min: 1, max: 6 }, 
            "壺鈴綜合訓練": { type: "肌力", min: 1, max: 6 },
        };
        
        // This is the default template if nothing is in the database.
        // It's based on the user's last request (empty Tuesday).
        const initialScheduleTemplate = {
            "週一": { "18:15-19:00": "壺鈴綜合訓練", "19:15-20:00": "入門跳床", "20:15-21:15": "懸吊TRX" },
            "週二": {},
            "週三": { "10:00-10:45": "基礎肌力", "11:00-12:00": "懸吊TRX", "18:15-19:00": "基礎肌力", "19:15-20:00": "燃脂跳床" },
            "週四": { "10:00-10:45": "基礎肌力", "11:15-12:00": "入門階梯", "14:00-15:00": "懸吊TRX", "18:15-19:00": "入門跳床", "19:15-20:00": "基礎肌力", "20:15-21:15": "懸吊TRX" },
            "週五": { "10:00-10:45": "入門跳床", "11:15-12:00": "壺鈴綜合訓練", "14:00-14:45": "基礎肌力", "18:15-19:00": "入門階梯", "19:15-20:00": "燃脂跳床", "20:15-21:00": "基礎肌力"},
            "週六": { "10:00-10:45": "入門跳床", "11:15-12:00": "燃脂跳床" }
        };
        
        // This variable will hold the schedule loaded from Firestore.
        let weeklyScheduleTemplate = {};
        let scheduleTemplateRef; // Will be set after DB init

        // --- DOM Elements ---
        const userInfoContainer = document.getElementById('userInfoContainer');
        const adminLoginModalEl = document.getElementById('adminLoginModal');
        const bookingModalEl = document.getElementById('bookingModal');
        const editDayModalEl = document.getElementById('editDayModal');
        const editScheduleTemplateModalEl = document.getElementById('editScheduleTemplateModal');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const todayBtn = document.getElementById('todayBtn');

        // --- Initialization ---
        function main() {
            if (firebaseConfig.apiKey) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    // Set the Firestore reference for the schedule template
                    scheduleTemplateRef = doc(db, `/artifacts/${appId}/public/data/schedule_templates`, 'main_template');
                } catch (e) { console.error("Firebase initialization failed:", e); }
            } else {
                 document.body.innerHTML = "Firebase 設定無效或不存在。";
                 return;
            }

            if (!auth) {
                document.body.innerHTML = "Firebase authentication service is not available.";
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    handleUserSession(user);
                } else {
                    // Sign in anonymously if no user
                    if (typeof __initial_auth_token !== 'undefined') {
                        signInWithCustomToken(auth, __initial_auth_token).catch(err => {
                            console.error("Custom token sign-in failed", err);
                            signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed", err));
                        });
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed", err));
                    }
                }
            });
        }
        main();

        // --- Auth & Session ---
        async function handleUserSession(user) {
            isAdmin = !user.isAnonymous;
            currentUserId = user.uid;
            currentUserName = isAdmin ? (user.email || 'Admin') : (localStorage.getItem('jpsUserName') || '');
            
            // CRITICAL: Load the schedule template *before* initializing the UI
            await loadScheduleTemplate();
            
            renderUserInfo();
            initializeSchedule(); // This will now use the loaded weeklyScheduleTemplate
            document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
            if (isAdmin) initializeAdminView();
        }

        function clearFirestoreListeners() {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        }

        // --- Schedule Template Management (NEW) ---
        async function loadScheduleTemplate() {
            try {
                const docSnap = await getDoc(scheduleTemplateRef);
                if (docSnap.exists()) {
                    weeklyScheduleTemplate = docSnap.data().schedule;
                } else {
                    // Document doesn't exist, use the initial template and set it in Firestore
                    console.log("No schedule template found, creating one...");
                    weeklyScheduleTemplate = initialScheduleTemplate;
                    await setDoc(scheduleTemplateRef, { schedule: initialScheduleTemplate });
                }
            } catch (error) {
                console.error("Error loading schedule template:", error);
                // Fallback to initial template in case of error
                weeklyScheduleTemplate = initialScheduleTemplate; 
            }
        }
        
        function openEditScheduleTemplateModal() {
            let courseOptions = Object.keys(courseDetails).map(c => `<option value="${c}">${c}</option>`).join('');
            
            let dayHtml = weekdays.map(day => {
                let daySchedule = weeklyScheduleTemplate[day] || {};
                // Sort by time
                let sortedEntries = Object.entries(daySchedule).sort((a, b) => a[0].localeCompare(b[0]));

                let classHtml = sortedEntries.map(([time, course]) => `
                    <div class="class-item flex justify-between items-center p-2 bg-gray-100 rounded">
                        <span class="font-mono">${time}</span>
                        <span>${course}</span>
                        <button class="delete-class-btn text-red-500 hover:text-red-700 font-bold" data-day="${day}" data-time="${time}">✕</button>
                    </div>
                `).join('');

                return `
                    <div class="day-editor p-4 border rounded-lg bg-white shadow-sm">
                        <h4 class="text-lg font-bold mb-3 text-center text-indigo-700">${day}</h4>
                        <div class="class-list space-y-2 mb-3 min-h-[50px]">${classHtml || '<p class="text-gray-400 text-sm text-center">本日無課程</p>'}</div>
                        <form class="add-class-form flex flex-col md:flex-row gap-2" data-day="${day}">
                            <input type="text" placeholder="HH:MM-HH:MM" class="time-input w-full md:w-2/5 p-2 border rounded font-mono" required>
                            <select class="course-select w-full md:w-2/5 p-2 border rounded bg-white">${courseOptions}</select>
                            <button type="submit" class="w-full md:w-1/5 bg-green-500 text-white p-2 rounded text-sm hover:bg-green-600">新增</button>
                        </form>
                    </div>
                `;
            }).join('');

            editScheduleTemplateModalEl.innerHTML = `
                <div class="modal-content bg-gray-100 rounded-xl shadow-lg w-11/12 max-w-6xl m-4 flex flex-col max-h-[90vh]">
                    <h3 class="p-6 text-2xl font-bold text-center border-b bg-white rounded-t-xl">編輯預設週課表</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-6 overflow-y-auto">
                        ${dayHtml}
                    </div>
                    <div class="p-4 flex-shrink-0 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button type="button" class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                        <button id="saveScheduleTemplateBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存並刷新</button>
                    </div>
                </div>
            `;

            // --- Add Event Listeners for the new modal ---
            
            // Helper function to add delete listener (since we add/remove items)
            const addDeleteListener = (btn) => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Just remove from UI. Save button will rebuild from the UI state.
                    e.target.closest('.class-item').remove(); 
                });
            };

            // Add listeners for existing delete buttons
            editScheduleTemplateModalEl.querySelectorAll('.delete-class-btn').forEach(addDeleteListener);

            // Add listeners for "add-class-form"
            editScheduleTemplateModalEl.querySelectorAll('.add-class-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const day = e.target.dataset.day;
                    const timeInput = e.target.querySelector('.time-input');
                    const time = timeInput.value.trim();
                    const course = e.target.querySelector('.course-select').value;
                    
                    // Simple time validation
                    if (!time.match(/^\d{2}:\d{2}-\d{2}:\d{2}$/)) {
                        // Use custom modal for alert
                        showCustomAlert("請輸入正確的時間格式 HH:MM-HH:MM (例如 19:15-20:00)");
                        timeInput.focus();
                        return;
                    }
                    
                    // Add to UI
                    const newList = e.target.closest('.day-editor').querySelector('.class-list');
                    if (newList.querySelector('p')) newList.innerHTML = ''; // Clear "no class" text
                    
                    const newItemEl = document.createElement('div');
                    newItemEl.className = 'class-item flex justify-between items-center p-2 bg-gray-100 rounded';
                    newItemEl.innerHTML = `
                        <span class="font-mono">${time}</span>
                        <span>${course}</span>
                        <button class="delete-class-btn text-red-500 hover:text-red-700 font-bold" data-day="${day}" data-time="${time}">✕</button>
                    `;
                    
                    // Add new item and re-sort
                    newList.appendChild(newItemEl);
                    const items = Array.from(newList.querySelectorAll('.class-item'));
                    items.sort((a, b) => a.querySelector('span.font-mono').textContent.localeCompare(b.querySelector('span.font-mono').textContent));
                    items.forEach(item => newList.appendChild(item));

                    // Add listener to the new delete button
                    addDeleteListener(newItemEl.querySelector('.delete-class-btn'));
                    
                    timeInput.value = ''; // Clear input
                });
            });

            editScheduleTemplateModalEl.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(editScheduleTemplateModalEl));
            editScheduleTemplateModalEl.querySelector('#saveScheduleTemplateBtn').addEventListener('click', handleSaveScheduleTemplate);
            
            openModal(editScheduleTemplateModalEl);
        }

        async function handleSaveScheduleTemplate() {
            const newTemplate = {};
            document.querySelectorAll('.day-editor').forEach(editor => {
                const day = editor.querySelector('h4').textContent; // "週一", "週二", etc.
                newTemplate[day] = {};
                editor.querySelectorAll('.class-item').forEach(item => {
                    const time = item.querySelector('span.font-mono').textContent;
                    const course = item.querySelector('span:not(.font-mono)').textContent;
                    newTemplate[day][time] = course;
                });
            });

            try {
                // Save to Firestore
                await setDoc(scheduleTemplateRef, { schedule: newTemplate });
                // Update in-memory variable
                weeklyScheduleTemplate = newTemplate; 
                
                closeModal(editScheduleTemplateModalEl);
                
                // Full refresh of the main schedule view
                await initializeSchedule(); 
                
                showCustomAlert("預設課表已儲存！");

            } catch (err) {
                console.error("Error saving schedule template:", err);
                showCustomAlert("儲存失敗，請稍後再試。");
            }
        }


        // --- User Info & Login ---
        function renderUserInfo() {
            const adminLoginIconContainer = document.getElementById('adminLoginIconContainer');
            if (isAdmin) {
                userInfoContainer.innerHTML = `<div class="p-3 bg-blue-100 border border-blue-200 rounded-lg text-center"><p class="text-sm text-blue-800">管理者模式：<strong>${currentUserName}</strong></p></div>`;
                adminLoginIconContainer.classList.add('hidden');
            } else {
                userInfoContainer.innerHTML = `
                    <div class="p-4 bg-orange-100 border border-orange-200 rounded-lg max-w-lg mx-auto w-full text-center">
                        <div class="flex items-center gap-2">
                            <label for="userNameInput" class="text-sm font-medium text-orange-800 whitespace-nowrap">您的姓名:</label>
                            <input type="text" id="userNameInput" class="w-full px-2 py-1 text-sm border-orange-300 rounded-md" placeholder="請輸入姓名以利報名">
                            <button id="saveNameBtn" class="px-4 py-1 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 relative overflow-hidden flex-shrink-0 w-20 h-8">
                                <span class="btn-text absolute inset-0 flex items-center justify-center transition-opacity duration-300">儲存</span>
                                <span class="save-feedback absolute inset-0 flex items-center justify-center bg-green-500 text-white rounded-md opacity-0 pointer-events-none transition-opacity duration-300">已儲存！</span>
                            </button>
                        </div>
                        <div id="user-guidance" class="text-sm text-gray-700 mt-3 h-5"></div>
                    </div>`;
                adminLoginIconContainer.classList.remove('hidden');
                document.getElementById('userNameInput').value = currentUserName;
                document.getElementById('saveNameBtn').addEventListener('click', saveUserName);
            }
        }

        function saveUserName() {
            const nameToSave = document.getElementById('userNameInput').value.trim();
            const guidanceEl = document.getElementById('user-guidance');
            const saveBtn = document.getElementById('saveNameBtn');
            const feedbackEl = saveBtn.querySelector('.save-feedback');
            const btnTextEl = saveBtn.querySelector('.btn-text');
            const scheduleWrapper = document.getElementById('schedule-wrapper');

            guidanceEl.innerHTML = '';

            if (nameToSave) {
                currentUserName = nameToSave;
                localStorage.setItem('jpsUserName', nameToSave);
                
                btnTextEl.classList.add('opacity-0');
                feedbackEl.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    btnTextEl.classList.remove('opacity-0');
                    feedbackEl.classList.add('opacity-0', 'pointer-events-none');
                }, 2000);

                guidanceEl.innerHTML = `<p class="text-indigo-700 font-semibold animate-pulse">您好，${currentUserName}！請點擊下方您想預約的課程。</p>`;
                scheduleWrapper.classList.add('glow-animation');
                scheduleWrapper.addEventListener('animationend', () => scheduleWrapper.classList.remove('glow-animation'), { once: true });
            } else {
                guidanceEl.innerHTML = `<p class="text-red-600 font-semibold">請輸入有效的姓名。</p>`;
                const userInput = document.getElementById('userNameInput');
                userInput.classList.add('shake-animation');
                userInput.addEventListener('animationend', () => userInput.classList.remove('shake-animation'), { once: true });
            }
        }
        
        document.getElementById('adminLoginIcon').addEventListener('click', () => {
             adminLoginModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-sm m-4 p-6">
                    <h3 class="text-xl font-bold text-center mb-4">管理者登入</h3>
                    <form id="adminLoginForm">
                        <div class="mb-4">
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700">電子郵件</label>
                            <input type="email" id="adminEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700">密碼</label>
                            <input type="password" id="adminPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <p id="loginError" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                        <div class="flex justify-end gap-4">
                            <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">登入</button>
                        </div>
                    </form>
                </div>`;
             adminLoginModalEl.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(adminLoginModalEl));
             adminLoginModalEl.querySelector('#adminLoginForm').addEventListener('submit', (e) => {
                 e.preventDefault();
                 const email = e.target.querySelector('#adminEmail').value;
                 const password = e.target.querySelector('#adminPassword').value;
                 const errorEl = e.target.querySelector('#loginError');
                 errorEl.classList.add('hidden');
                 signInWithEmailAndPassword(auth, email, password)
                     .then(() => closeModal(adminLoginModalEl))
                     .catch((err) => {
                         errorEl.textContent = "登入失敗，請檢查帳號或密碼。";
                         errorEl.classList.remove('hidden');
                     });
             });
             openModal(adminLoginModalEl);
        });

        // --- Admin Panel ---
        function initializeAdminView() {
            // Add listener for the new "Edit Schedule Template" button
            const editTemplateBtn = document.getElementById('editScheduleTemplateBtn');
            if (editTemplateBtn) {
                editTemplateBtn.addEventListener('click', openEditScheduleTemplateModal);
            }

            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                 adminLogoutBtn.addEventListener('click', () => {
                     signOut(auth).then(() => window.location.reload()).catch(err => console.error("Sign out failed:", err));
                 });
            }
            
            // You can add more admin-specific UI initialization here
            document.getElementById('adminCourseList').innerHTML = '<p class="text-gray-500">管理員功能已啟用。</p>';
        }

        // --- Modal Utilities ---
        function openModal(modal) { modal.classList.remove('opacity-0', 'pointer-events-none'); }
        function closeModal(modal) { modal.classList.add('opacity-0', 'pointer-events-none'); }
        
        // Custom Alert
        function showCustomAlert(message, type = 'error') {
            const confirmModalEl = document.getElementById('confirmModal');
            let bgColor = 'bg-red-100';
            let textColor = 'text-red-800';
            if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
            }

            confirmModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-sm m-4">
                    <div class="p-6">
                        <h3 class="text-lg font-bold text-center ${textColor} mb-4">${message}</h3>
                        <div class="flex justify-center">
                            <button type="button" class="close-confirm-btn px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">確認</button>
                        </div>
                    </div>
                </div>`;
            
            confirmModalEl.querySelector('.close-confirm-btn').addEventListener('click', () => closeModal(confirmModalEl));
            openModal(confirmModalEl);
        }

        // Custom Confirm
        function showCustomConfirm(message, callback) {
            const confirmModalEl = document.getElementById('confirmModal');
            confirmModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-sm m-4">
                    <div class="p-6">
                        <h3 class="text-lg font-bold text-center text-gray-800 mb-6">${message}</h3>
                        <div class="flex justify-center gap-4">
                            <button type="button" class="cancel-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                            <button type="button" class="confirm-btn px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">確定</button>
                        </div>
                    </div>
                </div>`;
            
            confirmModalEl.querySelector('.cancel-btn').addEventListener('click', () => closeModal(confirmModalEl));
            confirmModalEl.querySelector('.confirm-btn').addEventListener('click', () => {
                closeModal(confirmModalEl);
                callback(true); // User confirmed
            });
            openModal(confirmModalEl);
        }

        // --- Week Navigation ---
        prevWeekBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 7); initializeSchedule(); });
        nextWeekBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 7); initializeSchedule(); });
        todayBtn.addEventListener('click', () => { currentDate = new Date(); initializeSchedule(); });

        function getWeekInfo(refDate) {
            const today = new Date(refDate);
            today.setHours(0, 0, 0, 0); 
            const dayOfWeek = today.getDay(); 
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + diffToMonday);
            const weekDates = Array.from({ length: 6 }, (_, i) => { const d = new Date(monday); d.setDate(monday.getDate() + i); return d; });
            const saturday = weekDates[5];
            return { weekDates, rangeStr: `${monday.getMonth() + 1}/${monday.getDate()} - ${saturday.getMonth() + 1}/${saturday.getDate()}` };
        }

        function getClassDateTime(date, time) { 
            const [startTime] = time.split('-');
            const [hours, minutes] = startTime.split(':');
            const classDateTime = new Date(date);
            classDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return classDateTime;
        }

        // --- Main Schedule Rendering ---
        async function initializeSchedule() {
            clearFirestoreListeners(); 
            if (!currentUserId || !weeklyScheduleTemplate) {
                // Wait for auth and schedule template to be ready
                return;
            }
            
            const { weekDates, rangeStr } = getWeekInfo(currentDate);
            document.getElementById('weekRangeDisplay').textContent = rangeStr;

            // Fetch all overrides for the current week
            const startDate = weekDates[0].toISOString().slice(0, 10);
            const endDate = weekDates[5].toISOString().slice(0, 10);
            const overrides = {};
            try {
                const q = query(collection(db, `/artifacts/${appId}/public/data/schedule_overrides`), where('date', '>=', startDate), where('date', '<=', endDate));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => { overrides[doc.data().date] = doc.data(); });
            } catch (error) {
                console.error("Could not fetch schedule overrides.", error);
                if (error.code === 'permission-denied') { 
                    document.getElementById('app').innerHTML = `<div class="p-4 text-red-600"><strong>錯誤：</strong>無法載入課表。請檢查 Firebase 安全性規則是否允許 'public/data' 的讀取權限。</div>`; 
                    return; 
                }
            }
            
            // --- Re-draw the table ---
            scheduleContainer.innerHTML = ''; // Clear previous table
            const table = document.createElement('table');
            table.className = "w-full min-w-[900px] border-collapse text-center";
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const cornerTh = document.createElement('th');
            cornerTh.className = "w-[80px]";
            headerRow.appendChild(cornerTh);

            weekdays.forEach((day, index) => {
                const date = weekDates[index];
                const dateString = date.toISOString().slice(0, 10);
                const th = document.createElement('th');
                th.className = "font-bold p-2 bg-gray-100 align-middle border border-gray-200";
                let adminBtn = isAdmin ? `<button data-date="${dateString}" data-day-name="${day}" class="edit-day-btn text-xs mt-1 p-1 bg-gray-200 rounded font-normal hover:bg-gray-300">⚙️ 設定</button>` : '';
                th.innerHTML = `<div class="flex flex-col items-center"><span>${day}</span><span class="text-xs font-normal">${date.getMonth()+1}/${date.getDate()}</span>${adminBtn}</div>`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            
            // Get all unique time blocks from the template schedule
            const timeBlocks = {};
            Object.values(weeklyScheduleTemplate).forEach(daySchedule => {
                Object.keys(daySchedule).forEach(time => {
                    const hour = time.split(':')[0];
                    if(!timeBlocks[hour]) timeBlocks[hour] = [];
                    if(!timeBlocks[hour].includes(time)) timeBlocks[hour].push(time);
                });
            });

            // Draw rows for each hour block
            Object.keys(timeBlocks).sort().forEach((hour, hourIndex) => {
                const tr = document.createElement('tr');
                const prevHour = hourIndex > 0 ? Object.keys(timeBlocks).sort()[hourIndex - 1] : -1;
                // Add visual separators for noon and evening
                if ((hour >= 12 && prevHour < 12) || (hour >= 18 && prevHour < 18)) {
                    tr.classList.add('border-t-2', 'border-gray-300');
                }

                const timeTh = document.createElement('th');
                timeTh.scope = 'row';
                timeTh.className = 'font-bold text-gray-500 p-2 align-middle border border-gray-200';
                timeTh.textContent = `${hour}:00`;
                tr.appendChild(timeTh);

                // Draw cells for each day
                weekDates.forEach((date, dayIndex) => {
                    const dateString = date.toISOString().slice(0, 10);
                    const dayName = weekdays[dayIndex];
                    const td = document.createElement('td');
                    td.className = 'p-1 align-top border border-gray-200 space-y-1';
                    const overrideData = overrides[dateString];

                    if (overrideData?.status === 'rest_day') {
                        td.innerHTML = `<div class="h-full min-h-[120px] p-2 rounded-lg flex flex-col justify-center items-center text-left status-expired"><p class="font-bold">本日公休</p></div>`;
                    } else {
                        // Find classes for this hour block
                        timeBlocks[hour].forEach(time => {
                            if (overrideData?.cancelledClasses?.includes(time)) {
                                 td.innerHTML += `<div class="h-full min-h-[120px] p-2 rounded-lg flex flex-col justify-center items-center text-left status-expired"><p class="font-bold">本日停課</p></div>`;
                                 return; // Skip this class
                            }
                            
                            // Check for this class in the template
                            let courseName = weeklyScheduleTemplate[dayName]?.[time];
                            if (!courseName) return; // No class at this time in the template

                            // Apply overrides
                            let finalTime = overrideData?.timeChanges?.[time] || time;
                            if(overrideData?.classChanges?.[time]) courseName = overrideData.classChanges[time];
                            
                            // --- Create and Render the Course Card ---
                            const classDateTime = getClassDateTime(date, finalTime);
                            const courseId = `${dateString}-${time}`; // ID is based on *original* date and time
                            const finalCourseNameToPass = courseName;
                            const courseDiv = document.createElement('div');
                            courseDiv.className = 'min-h-[120px]'; // Ensure consistent height
                            courseDiv.innerHTML = `
                                <div id="${courseId}" class="course-card h-full p-2 rounded-lg flex flex-col border text-left">
                                    <div class="flex-grow">
                                        <p class="font-bold text-center ${courseName === '燃脂跳床' ? 'text-red-500' : ''}">${courseName}</p>
                                        <p class="text-xs text-center text-gray-500">${finalTime}</p>
                                        <div class="attendee-info mt-1 text-xs text-gray-700 overflow-y-auto h-10"></div>
                                    </div>
                                    <div class="pt-1">
                                        <div class="w-full progress-bar-bg rounded-full h-1.5"><div class="progress-bar bg-green-500 h-1.5 rounded-full"></div></div>
                                        <p class="text-xs text-right mt-1 text-gray-500">0/0</p>
                                    </div>
                                </div>`;
                            
                            const cardElement = courseDiv.firstElementChild;
                            const isExpired = new Date() > classDateTime;

                            if (!isExpired) {
                                cardElement.classList.add('cursor-pointer', 'transition-all', 'duration-200', 'hover:shadow-md', 'hover:-translate-y-1');
                                cardElement.addEventListener('click', () => openBookingModal(courseId, classDateTime, finalCourseNameToPass));
                            }

                            // Attach a real-time listener for this specific course's bookings
                            const unsub = onSnapshot(doc(db, `/artifacts/${appId}/public/data/courses`, courseId), (docSnap) => {
                                const dbData = docSnap.exists() ? docSnap.data() : { attendees: [] };
                                updateCardUI(courseId, { ...dbData, courseName: finalCourseNameToPass }, classDateTime);
                            }, (error) => {
                                if (error.code === 'permission-denied') console.error(`Permission denied for course ${courseId}.`);
                                else console.error(`Snapshot error for ${courseId}:`, error);
                            });
                            unsubscribeListeners.push(unsub);
                            
                            td.appendChild(courseDiv);
                        });
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            scheduleContainer.appendChild(table);
            
            // Add listeners for the admin 'Edit Day' buttons
            scheduleContainer.querySelectorAll('.edit-day-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.target.closest('.edit-day-btn');
                    openEditDayModal(button.dataset.date, button.dataset.dayName, overrides[button.dataset.date]);
                });
            });
        }
        
        // --- Course Card UI & Booking Modals ---
        
        function updateCardUI(courseId, courseData, classDateTime) {
            const cardEl = document.getElementById(courseId);
            if (!cardEl) return;
            
            const { attendees, courseName } = courseData;
            const details = courseDetails[courseName] || { min: 3, max: 8 }; // Default if course not in map
            const currentCount = attendees?.length || 0;
            const isExpired = new Date() > classDateTime;

            // Update attendee list
            cardEl.querySelector('.attendee-info').innerHTML = attendees && attendees.length > 0 ? attendees.map(p => `<div class="truncate">${p.name}</div>`).join('') : '<div class="text-gray-400">尚無人報名</div>';
            
            // Update progress bar
            const progressBar = cardEl.querySelector('.progress-bar');
            const progressText = cardEl.querySelector('.text-right');
            
            progressBar.style.width = `${(currentCount / details.max) * 100}%`;
            progressText.textContent = `${currentCount}/${details.max}`;
            
            progressBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
            
            // Update card status (color)
            cardEl.classList.remove('status-pending', 'status-confirmed', 'status-full', 'status-expired');
            if (isExpired) {
                cardEl.classList.add('status-expired');
                progressBar.style.width = '0%';
            } else if (currentCount >= details.max) {
                cardEl.classList.add('status-full');
                progressBar.classList.add('bg-red-500');
            } else if (currentCount >= details.min) {
                cardEl.classList.add('status-confirmed');
                progressBar.classList.add('bg-green-500');
            } else {
                cardEl.classList.add('status-pending');
                progressBar.classList.add('bg-yellow-500');
            }
        }

        async function openBookingModal(courseId, classDateTime, courseName) {
            if (!currentUserName && !isAdmin) {
                showCustomAlert("請先在上方輸入您的姓名並儲存，才能預約課程。");
                document.getElementById('userNameInput').focus();
                return;
            }
            
            const docRef = doc(db, `/artifacts/${appId}/public/data/courses`, courseId);
            const docSnap = await getDoc(docRef);
            const courseData = docSnap.exists() ? docSnap.data() : { attendees: [] };
            const bookingId = `${currentUserId}_${currentUserName}`;
            const isBooked = courseData.attendees?.some(p => p.id === bookingId);
            const now = new Date();
            
            // 6 hours * 60 minutes * 60 seconds * 1000 milliseconds
            const cancellationCutoffTime = new Date(classDateTime.getTime() - 6 * 60 * 60 * 1000); // 6 hours before class

            // Check booking/cancellation rules
            if (isBooked && now > cancellationCutoffTime && !isAdmin) { 
                // *** 這是更新後的提示訊息 ***
                showCustomAlert("已超過可取消時間（上課前六小時），請直接電話聯絡教練，否則將視同扣課。"); 
                return; 
            }
            if (!isBooked && now > classDateTime) { 
                showCustomAlert("課程已經開始，無法預約。"); 
                return; 
            }
            
            const details = courseDetails[courseName];
            if (!details) { 
                console.error(`Could not find details for course: ${courseName}`); 
                showCustomAlert("無法讀取課程資訊，請稍後再試。"); 
                return; 
            }
            
            const [date, time] = courseId.split('-');
            let attendeeListHtml = courseData.attendees?.map((p, i) =>
                `<li class="flex justify-between items-center py-1 ${p.id === bookingId ? 'font-bold text-indigo-600' : ''}">
                    <span>${i + 1}. ${p.name}</span>
                    ${isAdmin ? `<button data-id="${p.id}" data-name="${p.name}" class="remove-attendee-btn text-red-500 text-xs hover:text-red-700 px-2 py-1 bg-red-100 rounded">移除</button>` : ''}
                </li>`
            ).join('') || '<li class="text-gray-500">尚無人報名</li>';

            bookingModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-md m-4 p-6">
                    <h3 class="text-2xl font-bold text-center mb-2">${courseName}</h3>
                    <p class="text-center text-gray-500 mb-4">${date} ${time}</p>
                    <div class="mb-4">
                        <h4 class="font-bold mb-2">報名狀況 (${courseData.attendees?.length || 0}/${details.max})</h4>
                        <ul class="space-y-1 pl-2">${attendeeListHtml}</ul>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">關閉</button>
                        ${!isAdmin ? `<button id="bookingActionBtn" class="px-4 py-2 ${isBooked ? 'bg-red-600' : 'bg-green-600'} text-white rounded-lg">${isBooked ? '取消預約' : '確認預約'}</button>` : ''}
                    </div>
                </div>`;
                
            bookingModalEl.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(bookingModalEl));
            const bookingActionBtn = bookingModalEl.querySelector('#bookingActionBtn');
            if (bookingActionBtn) bookingActionBtn.addEventListener('click', () => handleBooking(courseId, courseName));
            if (isAdmin) {
                bookingModalEl.querySelectorAll('.remove-attendee-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idToRemove = e.target.dataset.id;
                        const nameToRemove = e.target.dataset.name;
                        showCustomConfirm(`您確定要移除 ${nameToRemove} 嗎？`, (confirmed) => {
                            if (confirmed) {
                                handleBooking(courseId, courseName, idToRemove);
                            }
                        });
                    });
                });
            }
            openModal(bookingModalEl);
        }

       async function handleBooking(courseId, courseName, adminRemoveId = null) {
            const docRef = doc(db, `/artifacts/${appId}/public/data/courses`, courseId);
            try {
                const docSnap = await getDoc(docRef);
                const currentAttendees = docSnap.exists() ? docSnap.data().attendees || [] : [];
                const currentUserBookingId = `${currentUserId}_${currentUserName}`;
                
                const isBooked = currentAttendees.some(p => p.id === currentUserBookingId);
                const isCancellation = adminRemoveId || isBooked;

                if (isCancellation) {
                    // --- Handle Cancellation ---
                    const idToRemove = adminRemoveId || currentUserBookingId;
                    const personToRemove = currentAttendees.find(p => p.id === idToRemove);
                    
                    if (!personToRemove) {
                        console.warn("Could not find person to remove.");
                        return;
                    }

                    // Admin removal is already confirmed by showCustomConfirm
                    // User cancellation:
                    if (!adminRemoveId) {
                        let confirmed = await new Promise((resolve) => {
                            showCustomConfirm("您確定要取消這個預約嗎？", resolve);
                        });
                        if (!confirmed) return;
                    }
                    
                    const newAttendees = currentAttendees.filter(p => p.id !== idToRemove);
                    await updateDoc(docRef, { attendees: newAttendees });

                } else {
                    // --- Handle New Booking ---
                    if (!currentUserName) { showCustomAlert("請輸入有效的姓名並儲存。"); return; }
                    
                    // Check if full
                    const details = courseDetails[courseName] || { max: 8 };
                    if (currentAttendees.length >= details.max) {
                        showCustomAlert("抱歉，這堂課已額滿。");
                        return;
                    }

                    const newUser = { id: currentUserBookingId, name: currentUserName };
                    const newAttendees = [...currentAttendees, newUser];
                    
                    if(docSnap.exists()) await updateDoc(docRef, { attendees: newAttendees });
                    else await setDoc(docRef, { courseName: courseName, attendees: newAttendees });
                }
            } catch (error) {
                console.error("Booking operation failed:", error);
                showCustomAlert("操作失敗，請稍後再試。");
            } finally {
                closeModal(bookingModalEl);
            }
        }
        
        // --- Admin Day Override Modal ---
        // (This function now reads from weeklyScheduleTemplate)
        async function openEditDayModal(date, dayName, overrideData) {
            const daySchedule = weeklyScheduleTemplate[dayName] || {};
            let classEditHtml = Object.keys(daySchedule).map(originalTime => {
                const courseName = weeklyScheduleTemplate[dayName][originalTime];
                const overrideClass = overrideData?.classChanges?.[originalTime] || courseName;
                const overrideTime = overrideData?.timeChanges?.[originalTime] || originalTime;
                const isCancelled = overrideData?.cancelledClasses?.includes(originalTime);
                const courseOptions = Object.keys(courseDetails).map(cName => `<option value="${cName}" ${cName === overrideClass ? 'selected' : ''}>${cName}</option>`).join('');
                return `
                    <div class="class-edit-item grid grid-cols-[auto,1fr,1fr] md:grid-cols-[20px,1fr,1fr,1fr] gap-3 items-center p-3 bg-gray-50 rounded-lg" data-original-time="${originalTime}">
                        <input type="checkbox" class="cancel-checkbox h-5 w-5" ${isCancelled ? 'checked' : ''}>
                        <div class="text-sm"> <p class="font-semibold ${isCancelled ? 'line-through' : ''}">${courseName}</p> <p class="text-xs text-gray-500">${originalTime}</p> </div>
                        <div class="md:col-span-1"><label class="block text-xs text-gray-600 mb-1">更換課程</label><select class="course-select w-full text-sm p-1 border rounded-md" ${isCancelled ? 'disabled' : ''}>${courseOptions}</select></div>
                        <div class="md:col-span-1"><label class="block text-xs text-gray-600 mb-1">修改時間</label><input type="text" class="time-input w-full text-sm p-1 border rounded-md" value="${overrideTime}" ${isCancelled ? 'disabled' : ''}></div>
                    </div>`;
            }).join('');
            if (!classEditHtml) classEditHtml = '<p class="text-center text-gray-500 py-4">本日無預設課程。</p>';

            editDayModalEl.innerHTML = `
                <div class="modal-content bg-white rounded-xl shadow-lg w-11/12 max-w-2xl m-4 flex flex-col max-h-[85vh]">
                    <div class="p-6 pb-4 flex-shrink-0 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-center mb-1">編輯 ${date} (${dayName})</h3>
                        <div class="text-center text-gray-500 mt-2">
                            <label class="flex items-center justify-center gap-2 cursor-pointer">
                                <input type="checkbox" id="restDayCheckbox" class="h-5 w-5" ${overrideData?.status === 'rest_day' ? 'checked' : ''}> 設定為公休日
                            </label>
                        </div>
                    </div>
                    <div id="class-edit-container" class="flex-grow overflow-y-auto p-6 space-y-3 ${overrideData?.status === 'rest_day' ? 'opacity-40 pointer-events-none' : ''}">
                        ${classEditHtml}
                    </div>
                    <div class="p-4 flex-shrink-0 border-t border-gray-200 bg-gray-50 rounded-b-xl">
                        <div class="flex flex-wrap justify-end gap-3">
                            ${overrideData ? '<button id="deleteOverridesBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">移除本日設定</button>' : ''}
                            <button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">取消</button>
                            <button id="saveOverridesBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">儲存變更</button>
                        </div>
                    </div>
                </div>`;

            const restDayCheckbox = editDayModalEl.querySelector('#restDayCheckbox');
            const classEditContainer = editDayModalEl.querySelector('#class-edit-container');
            restDayCheckbox.addEventListener('change', (e) => {
               classEditContainer.classList.toggle('opacity-40', e.target.checked);
               classEditContainer.classList.toggle('pointer-events-none', e.target.checked);
            });
            editDayModalEl.querySelectorAll('.cancel-checkbox').forEach(box => {
                box.addEventListener('change', (e) => {
                    const item = e.target.closest('.class-edit-item');
                    item.querySelector('.font-semibold').classList.toggle('line-through', e.target.checked);
                    item.querySelector('select').disabled = e.target.checked;
                    item.querySelector('input[type=text]').disabled = e.target.checked;
                });
            });
            editDayModalEl.querySelector('.close-modal-btn').addEventListener('click', () => closeModal(editDayModalEl));
            editDayModalEl.querySelector('#saveOverridesBtn').addEventListener('click', () => handleSaveOverrides(date, dayName));
            const deleteBtn = editDayModalEl.querySelector('#deleteOverridesBtn');
            if(deleteBtn) deleteBtn.addEventListener('click', () => {
                showCustomConfirm("您確定要清除這個日期的所有特殊設定嗎？", (confirmed) => {
                    if (confirmed) {
                        handleDeleteOverrides(date);
                    }
                });
            });
            openModal(editDayModalEl);
        }

        async function handleSaveOverrides(date, dayName) {
            const isRestDay = document.getElementById('restDayCheckbox').checked;
            const newOverrideData = { date };
            if (isRestDay) {
                newOverrideData.status = 'rest_day';
            } else {
                newOverrideData.cancelledClasses = [];
                newOverrideData.classChanges = {};
                newOverrideData.timeChanges = {};
                document.querySelectorAll('.class-edit-item').forEach(item => {
                    const originalTime = item.dataset.originalTime;
                    if (item.querySelector('.cancel-checkbox').checked) { newOverrideData.cancelledClasses.push(originalTime); return; }
                    
                    const newCourse = item.querySelector('.course-select').value;
                    // Only save if changed from template
                    if (newCourse !== weeklyScheduleTemplate[dayName][originalTime]) {
                        newOverrideData.classChanges[originalTime] = newCourse;
                    }
                    
                    const newTime = item.querySelector('.time-input').value;
                    // Only save if changed from original time
                    if (newTime !== originalTime) {
                        newOverrideData.timeChanges[originalTime] = newTime;
                    }
                });
                if (Object.keys(newOverrideData.classChanges).length === 0) delete newOverrideData.classChanges;
                if (Object.keys(newOverrideData.timeChanges).length === 0) delete newOverrideData.timeChanges;
                if (newOverrideData.cancelledClasses.length === 0) delete newOverrideData.cancelledClasses;
            }

            // If no overrides are set, delete the doc instead
            if (Object.keys(newOverrideData).length <= 1) { 
                await handleDeleteOverrides(date); 
                return; 
            }
            
            const docRef = doc(db, `/artifacts/${appId}/public/data/schedule_overrides`, date);
            try { 
                await setDoc(docRef, newOverrideData); 
            }
            catch (error) { console.error("Failed to save overrides:", error); showCustomAlert("儲存設定失敗！"); }
            finally { 
                closeModal(editDayModalEl); 
                initializeSchedule(); // Refresh main view
            }
        }
        
        async function handleDeleteOverrides(date) {
            const docRef = doc(db, `/artifacts/${appId}/public/data/schedule_overrides`, date);
            try { 
                await deleteDoc(docRef); 
            }
            catch (error) { console.error("Failed to delete overrides:", error); showCustomAlert("移除設定失敗！"); }
            finally { 
                closeModal(editDayModalEl); 
                initializeSchedule(); // Refresh main view
            }
        }
    </script>
</body>
</html>
